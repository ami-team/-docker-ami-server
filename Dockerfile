########################################################################################################################

FROM amazoncorretto:17-alpine

########################################################################################################################

LABEL maintainer="Jérôme ODIER <odier.jerome@lpsc.in2p3.fr>"

LABEL description="AMI Server"

########################################################################################################################

ENV JAVA_MS="2G"
ENV JAVA_MX="4G"
ENV JAVA_SS="20m"

ENV HTTP_TIMEOUT="20000"
ENV HTTP_MAX_THREADS="200"
ENV HTTP_PACKET_SIZE="8192"

ENV AJP_ADDRESS="0.0.0.0"
ENV AJP_SECRET="changeit"

ENV AJP_TIMEOUT="20000"
ENV AJP_MAX_THREADS="200"
ENV AJP_PACKET_SIZE="8192"

ENV JVM_ROUTE="changeit"

ENV BASE_URL=""

ENV ADMIN_USER=""
ENV ADMIN_PASS=""
ENV ADMIN_EMAIL=""

ENV ENCRYPTION_KEY=""
ENV AUTHORIZED_IPS=""

ENV ROUTER_CATALOG=""
ENV ROUTER_SCHEMA="@NULL"
ENV ROUTER_URL=""
ENV ROUTER_USER=""
ENV ROUTER_PASS=""

ENV TIME_ZONE="UTC"

ENV CLASS_PATH="/AMI/cmd/"

########################################################################################################################

RUN ["apk", "add", "--update", "--no-cache", "bash", "curl", "openssl"]

########################################################################################################################

RUN ["wget", "-O", "AMI-bundle.zip", "https://repo.ami-ecosystem.in2p3.fr/releases/net/hep/ami/AMICoreWeb/1.0.0/AMICoreWeb-1.0.0-bundle.zip"]
RUN ["unzip", "AMI-bundle.zip"]
RUN ["rm", "AMI-bundle.zip"]

########################################################################################################################

RUN ["mkdir", "-p", "/AMI/temp/"]
RUN ["mkdir", "-p", "/AMI/work/"]

########################################################################################################################

RUN ["chmod", "777", "/AMI/temp/", "/AMI/work/"]

########################################################################################################################

COPY docker-entrypoint.sh /docker-entrypoint.sh

RUN ["chmod", "a+x", "/docker-entrypoint.sh"]

########################################################################################################################

EXPOSE 8443
EXPOSE 8080
EXPOSE 8009

########################################################################################################################

VOLUME /AMI/cmd/

########################################################################################################################

WORKDIR /AMI/

########################################################################################################################

ENTRYPOINT ["/docker-entrypoint.sh"]

########################################################################################################################
